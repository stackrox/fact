name: Rust CI

on:
  push:
    branches:
    - main
    - release-*
    tags:
    - '*'
  pull_request:

concurrency:
  # append event name on the off chance that a push to master
  # runs at the same time as the nightlies - we want both to run
  group: ${{ github.head_ref || github.run_id }}-${{ github.event_name }}
  cancel-in-progress: true

jobs:
  basic:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        args:
          - build --release
          - clippy -- -D warnings
          - test
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libbpf-dev \
          protobuf-compiler
    - shell: python
      id: args
      run: |
        import os

        # Remove the hyphens from arguments like --release, then join
        # all words with hyphens to have a key that is valid for GHA
        # caching.
        args='${{ matrix.args }}'.replace('-', '').split()
        args='-'.join(args)
        with open(os.environ.get('GITHUB_OUTPUT'), 'a') as f:
          f.write(f'args={args}')

    - uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ steps.args.outputs.args }}-${{ hashFiles('**/Cargo.lock') }}
    - run: cargo ${{ matrix.args }}

  container:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true
    - run: make image
